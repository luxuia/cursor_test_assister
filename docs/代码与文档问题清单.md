# 代码与文档问题清单

基于当前代码框架与 README/ARCHITECTURE/后续开发计划 等文档的对照检查结果。

---

## 一、已确认的问题

### 1. Data 目录未复制到输出目录（影响运行）

- **位置**：`GameAssistant/GameAssistant.csproj`
- **现象**：运行时工作目录多为 `bin/Debug/net8.0-windows/`，而 `Data/Dota2Heroes.json`、`Data/Dota2Items.json` 等仅在项目根或 `GameAssistant/Data/` 存在，未复制到输出目录。
- **影响**：从 IDE 或双击 exe 运行时，`HeroDownloadWindow` 加载英雄/物品列表、`LiquipediaDataGenerator` 读写 Data 时可能 `FileNotFoundException`（`HeroIconDownloader.FindFile` 会尝试 BaseDirectory/CurrentDirectory，仍可能找不到）。
- **建议**：在 csproj 中增加将 `Data` 目录内容复制到输出目录，例如：
  ```xml
  <ItemGroup>
    <None Update="Data\**\*" CopyToOutputDirectory="PreserveNewest" Link="Data\%(RecursiveDir)%(Filename)%(Extension)" />
  </ItemGroup>
  ```
  若 Data 在项目根，则用 `..\Data\**\*` 或把 Data 放到 GameAssistant 下并写为 `Data\**\*`。

### 2. 区域选择器坐标系与采集坐标系不一致（逻辑错误）

- **位置**：`GameAssistant/Views/RegionSelectorWindow.xaml.cs`（约 56–66 行）、`ImageRecognizer` 使用 `RecognitionRegions` 裁剪
- **现象**：`RegionSelectorWindow` 用 `PointToScreen` 得到的是**屏幕坐标**，保存到 `RecognitionRegions`；而 `WindowsScreenCapture.CaptureWindow` 得到的是**游戏窗口客户区/窗口矩形**的位图，即 (0,0) 为窗口左上角。
- **影响**：用“屏幕矩形”去裁剪“窗口位图”，区域错位，识别区域错误。
- **建议**：
  - 方案 A：区域选择时传入当前游戏窗口的窗口矩形（或客户区矩形），选择完成后将“屏幕矩形”转换为**相对该窗口的矩形**再保存。
  - 方案 B：若改为“全屏截图”再识别，则需改为全屏采集，且区域为屏幕坐标（当前实现是窗口采集，不适用）。

### 3. 调试窗口未接入真实采集与识别管线（占位实现）

- **位置**：`GameAssistant/Views/DebugWindow.xaml.cs` 的 `CaptureAndRecognize()`（约 54–76 行）
- **现象**：仅 `await Task.Delay(100)`，未从 `MainViewModel` 或采集器取当前帧，也未调用 `IImageRecognizer`，未更新 `UpdateFrame`/`UpdateRecognitionResults`。
- **影响**：调试窗口无法看到真实画面和识别结果，无法用于调参和排错。
- **建议**：由 MainViewModel 提供“当前最新一帧”和“对指定 Bitmap 执行一次识别并返回结果”的接口（或事件），Debug 窗口在“捕获当前帧”/“自动刷新”时取帧、调用识别、更新 UI（OriginalImage/RegionImage 与各结果列表）。

### 4. DebugWindow 中 Bitmap 转 BitmapSource 的像素格式假设错误（易花屏/崩溃）

- **位置**：`GameAssistant/Views/DebugWindow.xaml.cs` 的 `ConvertBitmap()`（约 150–169 行）
- **现象**：固定使用 `PixelFormats.Bgr24` 和 `bitmapData.Stride`；而 `WindowsScreenCapture.CaptureWindow` 使用的是 `Format32bppArgb`（stride = width×4），与 Bgr24（3 字节/像素）不一致。
- **影响**：显示错位、花屏或异常。
- **建议**：按 `bitmap.PixelFormat` 分支处理，例如 32bppArgb 时使用 `PixelFormats.Bgra32` 和原有 stride；或统一将位图转换为 Bgra32 再创建 BitmapSource。

### 5. 规则管理：导入/导出仍为占位

- **位置**：`GameAssistant/Views/RuleManagementWindow.xaml.cs` 的 `ImportButton_Click`、`ExportButton_Click`（约 268–315 行）
- **现象**：弹窗“导入/导出功能待实现”，未读写 JSON。
- **影响**：无法备份或迁移规则。
- **建议**：导出：将当前 `_rules` 序列化为 JSON 写入用户选择路径；导入：从选中文件反序列化，与现有规则合并或替换，再写回 `IAdviceDatabase` 并刷新列表。

### 6. 模板预加载未包含子目录（性能/一致性）

- **位置**：`GameAssistant/Services/ImageRecognition/TemplateMatcher.cs` 的 `PreloadAllTemplates()`（约 211–222 行）
- **现象**：仅 `Directory.GetFiles(_templateDirectory, "*.png")`，不包含 `Templates/Heroes/`、`Templates/Equipment/` 等子目录。
- **影响**：英雄/装备模板不会预加载，首次识别时按需 LoadTemplate，功能可用但首帧或首区域识别更慢；若模板路径约定与 `ImageRecognizer` 中 key（如 `Heroes/xxx`）不一致，可能漏载。
- **建议**：递归扫描子目录（如 `Directory.GetFiles(..., "*.png", SearchOption.AllDirectories)`），并按相对路径生成 templateName（与 `ImageRecognizer` 中使用的 key 一致），便于预加载与缓存一致。

### 7. 可能的错误目录名

- **位置**：仓库根目录下存在名为 `{Assistant` 的目录（内含 `Tools/LiquipediaScraper.cs`）
- **现象**：与 `GameAssistant` 易混淆，疑似复制或重命名错误。
- **建议**：若为无用副本，可删除或重命名为规范名称，避免混淆和重复维护。

---

## 二、与文档的差异或需更新的说明

### 1. README / 使用说明

- 已说明“先配置游戏窗口、再配置识别区域、再开始识别”，与当前“未设置窗口句柄时 StartRecognition 报错”一致，可补充一句：**若未查找/配置游戏窗口，点击“开始识别”会提示“未找到游戏窗口”**。
- “建议规则管理UI”在 README 的 TODO 中已标为已完成，与当前规则管理窗口存在一致；但“在设置界面管理规则（待实现）”应改为“在规则管理窗口管理规则（已实现）”，仅导入/导出仍待实现。

### 2. docs/后续开发计划.md

- “待完善”中“建议规则管理UI”可改为“已实现”；“规则导入/导出”可单独列为待实现。
- “图像识别的具体实现”“模板匹配的实际应用”已部分实现（英雄/装备/小地图/状态等），文档可更新为“已实现基础版，待调参与扩展”。

### 3. ARCHITECTURE.md

- 与当前实现大体一致；若后续将“区域为窗口相对坐标”写进设计，建议在“画面采集”与“识别区域”小节中明确说明“所有识别区域均为相对捕获窗口的坐标”。

---

## 三、建议修复顺序（✅ 已全部完成）

1. **高**：Data 复制到输出目录（保证运行不报错）。✅ 已修复（csproj）
2. **高**：DebugWindow 的 ConvertBitmap 按 32bpp 修正（避免花屏/异常）。✅ 已修复
3. **高**：调试窗口接入真实帧与识别管线（便于后续开发与调参）。✅ 已修复
4. **中**：区域选择器改为“窗口相对坐标”（或明确文档说明当前为屏幕坐标及适用场景）。✅ 已修复（传入窗口句柄并转换坐标）
5. **中**：规则管理实现导入/导出 JSON。✅ 已修复
6. **低**：TemplateMatcher 递归预加载子目录；清理或重命名 `{Assistant` 目录。✅ 已修复（递归子目录；已删除错误目录下重复文件）

---

## 四、其他检查结论（无问题或已满足）

- **Program.cs / App.xaml.cs**：`RunLiquipediaDataGenerator`、`UpdateIconsFromLiquipedia`、`RunImageRecognitionTest` 均存在且被正确引用。
- **GameWindowConfig**：已含 `using System`，`IntPtr` 使用正常。
- **HeroDownloadWindow**：使用 `GameAssistant.Tools` 下的 `HeroInfo`/`ItemInfo`，`FindFile` 会尝试多路径；在 Data 复制到输出后即可稳定工作。
- **StatusResult**：已包含 `ManaPercentage`，与 DebugWindow 绑定一致。
- **RecognitionParameters**：包含 `MinimapRecognition`、`EquipmentRecognition` 等，与 `ImageRecognizer` 使用一致。

以上为本次对照代码与文档后的完整问题清单与建议。
